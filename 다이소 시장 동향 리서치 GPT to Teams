import feedparser
import requests
import datetime

# âœ… ì„¤ì •
OPENAI_API_KEY = "sk-..."  # â† OpenAI API í‚¤ ì…ë ¥
TEAMS_WEBHOOK_URL = "https://..."  # â† Teams Webhook URL ì…ë ¥
KEYWORD = "ë‹¤ì´ì†Œ"
RSS_FEED = f"https://news.google.com/rss/search?q={KEYWORD}&hl=ko&gl=KR&ceid=KR:ko"

# 1ï¸âƒ£ ë‰´ìŠ¤ 10ê°œ ìˆ˜ì§‘
feed = feedparser.parse(RSS_FEED)
articles = feed.entries[:10]  # â† 10ê°œ ì´ìƒìœ¼ë¡œ ë³€ê²½
if len(articles) < 5:
    raise Exception("ë‰´ìŠ¤ ìˆ˜ê°€ ë„ˆë¬´ ì ìŠµë‹ˆë‹¤. í‚¤ì›Œë“œ ë˜ëŠ” RSS í”¼ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.")

# 2ï¸âƒ£ ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸ ì •ë¦¬
news_items = []
for i, entry in enumerate(articles, 1):
    news_items.append(f"{i}. ì œëª©: {entry.title}\n   ë§í¬: {entry.link}")

news_block = "\n".join(news_items)

# 3ï¸âƒ£ GPT í”„ë¡¬í”„íŠ¸ êµ¬ì„±
now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M")
prompt = f"""
ë‹¤ìŒì€ '{KEYWORD}'ì™€ ê´€ë ¨ëœ ìµœê·¼ ë‰´ìŠ¤ ê¸°ì‚¬ 10ê±´ì…ë‹ˆë‹¤.
ì´ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ë‹¤ìŒ í˜•ì‹ì— ë”°ë¼ í•œêµ­ì–´ ë¦¬ì„œì¹˜ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.

ğŸ“¢ ì˜¤ëŠ˜ì˜ {KEYWORD} ì‹œì¥ ë™í–¥ ë¦¬ì„œì¹˜ ìš”ì•½

ğŸ”¹ ì œëª©: [í•µì‹¬ í‚¤ì›Œë“œë¥¼ ë‹´ì€ ë¶„ì„ ì œëª©]

ğŸ”¹ í•µì‹¬ ìš”ì•½:
[ì „ì²´ ê¸°ì‚¬ íë¦„ì„ ê°„ê²°í•˜ì§€ë§Œ í’ë¶€í•˜ê²Œ 3~4ì¤„ë¡œ ìš”ì•½]

ğŸ”¹ ì£¼ìš” ì´ìŠˆ ë¶„ì„:
- [ì´ìŠˆ 1: ì„¤ëª…]
- [ì´ìŠˆ 2: ì„¤ëª…]
- ...

ğŸ”¹ ì—…ê³„ ë° ì‹œì¥ ë°˜ì‘:
[ì‹œì¥/ì†Œë¹„ì/ì—…ê³„ì˜ ë°˜ì‘ì„ ë¶„ì„]

ğŸ”¹ í–¥í›„ ì „ë§ ë° ì‹œì‚¬ì :
[GPT ê´€ì ì˜ ì˜ˆì¸¡ ë° ì¡°ì–¸ í¬í•¨]

â± ë¦¬í¬íŠ¸ ìƒì„± ì‹œê°: {now}

ë‰´ìŠ¤ ëª©ë¡:
{news_block}
"""

# 4ï¸âƒ£ GPT API í˜¸ì¶œ
headers = {
    "Authorization": f"Bearer {OPENAI_API_KEY}",
    "Content-Type": "application/json"
}
payload = {
    "model": "gpt-3.5-turbo",
    "messages": [
        {"role": "system", "content": "ë„ˆëŠ” ì‹œì¥ ë™í–¥ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” ë¦¬ì„œì¹˜ ì „ë¬¸ê°€ì•¼.í•µì‹¬ ë‚´ìš©, ë°°ê²½, ì˜í–¥ ë“±ì„ í¬í•¨í•´ì„œ í’ë¶€í•˜ê³  ì •í™•í•˜ê²Œ ì„¤ëª…í•´ì¤˜."},
        {"role": "user", "content": prompt}
    ],
    "temperature": 0.7
}

response = requests.post("https://api.openai.com/v1/chat/completions", headers=headers, json=payload)
summary = response.json()["choices"][0]["message"]["content"]

# 5ï¸âƒ£ Teams ì „ì†¡
teams_payload = {
    "text": summary + "\n\nğŸ“° ì°¸ê³  ê¸°ì‚¬ ëª©ë¡:\n" + news_block
}
res = requests.post(TEAMS_WEBHOOK_URL, json=teams_payload)

# 6ï¸âƒ£ ìƒíƒœ ì¶œë ¥
if res.status_code == 200:
    print("âœ… Teams ì „ì†¡ ì™„ë£Œ")
else:
    print(f"âŒ Teams ì „ì†¡ ì‹¤íŒ¨: {res.status_code}\n{res.text}")
